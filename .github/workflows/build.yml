name: Build Camera Proxy

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86  # 32-bit build for DMC4

    # ── Formatting ────────────────────────────────────────────────────────────
    # clang-format auto-fixes style issues and commits the result.
    # To customise rules, add a .clang-format file at the repo root.
    - name: Run clang-format (auto-fix)
      shell: pwsh
      run: |
        $files = Get-ChildItem -Recurse -Include *.cpp,*.h -Exclude imgui/* |
                 Select-Object -ExpandProperty FullName
        foreach ($f in $files) {
          clang-format -i $f
        }

    - name: Commit clang-format fixes
      shell: pwsh
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        if ($(git status --porcelain) -eq "") { Write-Host "No changes, skipping."; exit 0 }
        git add -A
        git commit -m "style: apply clang-format auto-fixes [skip ci]"
        git push

    # ── Static analysis ───────────────────────────────────────────────────────
    # clang-tidy checks for common bugs, modernisation opportunities, and more.
    # --fix applies every suggestion that clang-tidy can safely automate.
    # Warnings that can't be fixed automatically are printed to the log.
    # The step uses --warnings-as-errors=* so unfixable issues fail the job.
    - name: Run clang-tidy (auto-fix)
      shell: pwsh
      run: |
        # Build a minimal compile-commands entry so clang-tidy understands
        # the project's include paths and preprocessor defines.
        $includes = "-Id3d9_proxy -Iimgui -Iimgui/backends"
        $defines  = "-DWIN32 -D_WINDOWS -DUNICODE"
        $flags    = "$includes $defines --std=c++17"

        clang-tidy d3d9_proxy.cpp `
          --fix `
          --fix-errors `
          -- $flags.Split(" ")

    - name: Commit clang-tidy fixes
      shell: pwsh
      run: |
        git config user.name  "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        if ($(git status --porcelain) -eq "") { Write-Host "No changes, skipping."; exit 0 }
        git add -A
        git commit -m "fix: apply clang-tidy auto-fixes [skip ci]"
        git push

    # ── Build ─────────────────────────────────────────────────────────────────
    - name: Build D3D9 Proxy DLL
      run: |
        cl /LD /EHsc /O2 /MD d3d9_proxy.cpp imgui/imgui.cpp imgui/imgui_draw.cpp imgui/imgui_tables.cpp imgui/imgui_widgets.cpp imgui/backends/imgui_impl_dx9.cpp imgui/backends/imgui_impl_win32.cpp /link /DEF:d3d9.def /OUT:d3d9.dll
      shell: cmd

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: camera-proxy-dll
        path: |
          d3d9.dll
          camera_proxy.ini
          INSTALL.txt
