name: Build Camera Proxy

on:
  workflow_dispatch:  # Manual trigger only

jobs:
  lint-and-fix:
    runs-on: windows-latest
    permissions:
      contents: write  # Required to commit auto-fixes back to the repo

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup LLVM (clang-tidy + clang-format)
      uses: KyleMayes/install-llvm-action@v2
      with:
        version: "17"

    - name: Setup Visual Studio environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86  # 32-bit build for DMC4

    # ── Formatting ────────────────────────────────────────────────────────────
    # clang-format can fix 100% of what it flags, so we run it first and
    # commit any changes before the stricter static-analysis step.
    - name: Run clang-format (auto-fix)
      shell: bash
      run: |
        find . -name "*.cpp" -o -name "*.h" | \
          grep -v "imgui/" | \
          xargs clang-format -i --style=file

    # ── Static analysis ───────────────────────────────────────────────────────
    # clang-tidy can auto-fix a subset of its checks. We apply those fixes,
    # then run a second read-only pass to catch anything that couldn't be
    # fixed automatically and fail the build if any remain.
    - name: Run clang-tidy (auto-fix where possible)
      shell: bash
      run: |
        # Disabled checks explanation:
        #   modernize-use-trailing-return-type   — conflicts with WINAPI/BOOL calling conventions
        #   readability-magic-numbers            — too noisy in D3D/Win32 code (flags SDK constants)
        #   readability-identifier-length        — flags idiomatic Win32 names like 'hr', 'cb'
        #   modernize-avoid-c-arrays             — char[] arrays are standard in Win32/interop code
        #   clang-diagnostic-deprecated-declarations — MSVC fopen_s deprecation is a false positive here
        CHECKS="clang-diagnostic-*,clang-analyzer-*,modernize-*,readability-*,bugprone-*,performance-*"
        CHECKS="$CHECKS,-modernize-use-trailing-return-type"
        CHECKS="$CHECKS,-readability-magic-numbers"
        CHECKS="$CHECKS,-readability-identifier-length"
        CHECKS="$CHECKS,-modernize-avoid-c-arrays"
        CHECKS="$CHECKS,-clang-diagnostic-deprecated-declarations"
        find . -name "*.cpp" | grep -v "imgui/" | while read -r file; do
          clang-tidy "$file" \
            --fix \
            --fix-errors \
            -checks="$CHECKS" \
            -- -std=c++17 -m32 -I. -Iimgui \
            2>&1 || true  # Don't abort here; unfixable issues caught in next step
        done

    - name: Commit auto-fixes (formatting + lint)
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "style: apply clang-format and clang-tidy auto-fixes [skip ci]"
        file_pattern: "*.cpp *.h"

    # ── Verification pass ─────────────────────────────────────────────────────
    # Read-only re-run to catch any issues that couldn't be auto-fixed.
    # This is what actually gates the build.
    - name: Verify no remaining lint errors
      shell: bash
      run: |
        CHECKS="clang-diagnostic-*,clang-analyzer-*,modernize-*,readability-*,bugprone-*,performance-*"
        CHECKS="$CHECKS,-modernize-use-trailing-return-type"
        CHECKS="$CHECKS,-readability-magic-numbers"
        CHECKS="$CHECKS,-readability-identifier-length"
        CHECKS="$CHECKS,-modernize-avoid-c-arrays"
        CHECKS="$CHECKS,-clang-diagnostic-deprecated-declarations"
        CHECKS="$CHECKS,-readability-function-cognitive-complexity"
        ERRORS=0
        # Use process substitution (< <(...)) instead of a pipe so ERRORS
        # stays in the main shell rather than a subshell where it can't propagate.
        while read -r file; do
          clang-tidy "$file" \
            -checks="$CHECKS" \
            -- -std=c++17 -m32 -I. -Iimgui \
            || ERRORS=$((ERRORS + 1))
        done < <(find . -name "*.cpp" | grep -v "imgui/")
        if [ "$ERRORS" -gt 0 ]; then
          echo "::error::$ERRORS file(s) have lint errors that could not be auto-fixed. Please fix them manually."
          exit 1
        fi

  build:
    runs-on: windows-latest
    needs: lint-and-fix  # Only runs if lint-and-fix passes

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Setup Visual Studio environment
      uses: ilammy/msvc-dev-cmd@v1
      with:
        arch: x86  # 32-bit build for DMC4

    - name: Build D3D9 Proxy DLL
      run: |
        cl /LD /EHsc /O2 /MD d3d9_proxy.cpp imgui/imgui.cpp imgui/imgui_draw.cpp imgui/imgui_tables.cpp imgui/imgui_widgets.cpp imgui/backends/imgui_impl_dx9.cpp imgui/backends/imgui_impl_win32.cpp /link /DEF:d3d9.def /OUT:d3d9.dll
      shell: cmd

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: camera-proxy-dll
        path: |
          d3d9.dll
          camera_proxy.ini
          INSTALL.txt
